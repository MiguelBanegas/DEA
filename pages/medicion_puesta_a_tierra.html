<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <link rel="shortcut icon" href="../img/logoDEA3.jfif" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <link rel="stylesheet" href="../css/styles.css?v1.1">

  <title>PROTOCOLO DE MEDICIÓN</title>
  
</head>

<body>
  <div id="exportPDF">
    <form id="protocoloForm">
      <img src="../img/logoDEA3.jfif" alt="Logo" style="position: absolute; top: 10px; left: 10px; width: 150px;">
      <h2 class="title">Protocolo de Medición de la Puesta a Tierra y Continuidad de las Masas</h2>

      <label for="razon_social">Razón Social:</label>
      <input type="text" id="razon_social" name="razon_social" placeholder="Ingrese la razón social" required>
      <span class="error-message" id="razon_social_error"></span>

      <label for="cuit">C.U.I.T.:</label>
      <input type="text" id="cuit" name="cuit" placeholder="XX-XXXXXXXX-X" required title="El CUIT debe tener el formato XX-XXXXXXXX-X">
      <span class="error-message" id="cuit_error"></span>

      <label for="direccion">Dirección:</label>
      <input type="text" id="direccion" name="direccion" placeholder="Ingrese la dirección" required>
      <span class="error-message" id="direccion_error"></span>

      <label for="localidad">Localidad:</label>
      <input type="text" id="localidad" name="localidad" placeholder="Ingrese la localidad" required>
      <span class="error-message" id="localidad_error"></span>

      <div style="display: flex; gap: 20px;">
        <div style="flex: 1;">
          <label for="cp">CP:</label>
          <input type="text" id="cp" name="cp" placeholder="Ingrese el código postal" required>
          <span class="error-message" id="cp_error"></span>
        </div>
        <div style="flex: 1;">
          <label for="provincia">Provincia:</label>
          <select id="provincia" name="provincia" required>
            <option value="">Seleccionar Provincia</option>
            <option value="Buenos Aires">Buenos Aires</option>
            <option value="Catamarca">Catamarca</option>
            <option value="Chaco">Chaco</option>
            <option value="Chubut">Chubut</option>
            <option value="Córdoba">Córdoba</option>
            <option value="Corrientes">Corrientes</option>
            <option value="Entre Ríos">Entre Ríos</option>
            <option value="Formosa">Formosa</option>
            <option value="Jujuy">Jujuy</option>
            <option value="La Pampa">La Pampa</option>
            <option value="La Rioja">La Rioja</option>
            <option value="Mendoza">Mendoza</option>
            <option value="Misiones">Misiones</option>
            <option value="Neuquén">Neuquén</option>
            <option value="Río Negro">Río Negro</option>
            <option value="Salta">Salta</option>
            <option value="San Juan">San Juan</option>
            <option value="San Luis">San Luis</option>
            <option value="Santa Cruz">Santa Cruz</option>
            <option value="Santa Fe">Santa Fe</option>
            <option value="Santiago del Estero">Santiago del Estero</option>
            <option value="Tierra del Fuego, Antártida e Islas del Atlántico Sur">Tierra del Fuego, Antártida e Islas
              del Atlántico Sur</option>
            <option value="Tucumán">Tucumán</option>
          </select>
          <span class="error-message" id="provincia_error"></span>
        </div>

      </div>
          <!-- <hr> -->
      <div class="section-title">DATOS DEL PROFESIONAL QUE VA REALIZAR LAS MEDICIONES</div>

      <label for="nombre_profesional">Nombre:</label>
      <input type="text" id="nombre_profesional" name="nombre_profesional" placeholder="Ingrese el nombre del profesional" required>
      <span class="error-message" id="nombre_profesional_error"></span>

      <label for="apellido_profesional">Apellido:</label>
      <input type="text" id="apellido_profesional" name="apellido_profesional" placeholder="Ingrese el apellido del profesional" required>
      <span class="error-message" id="apellido_profesional_error"></span>

      <label for="matricula_profesional">Matrícula N°:</label>
      <input type="text" id="matricula_profesional" name="matricula_profesional" placeholder="Ingrese la matrícula" required>
      <span class="error-message" id="matricula_profesional_error"></span>

      <label for="incumbencias_electricidad">Posee incumbencias específicas en electricidad (si /no ):</label>
      <select id="incumbencias_especificas" name="incumbencias_especificas" required>
        <option value="Técnico eléctrico">Técnico eléctrico</option>
        <option value="Técnico Electromecánico">Técnico Electromecánico</option>
        <option value="Ingeniero eléctrico">Ingeniero eléctrico</option>
        <option value="Ingeniero electromecánico">Ingeniero electromecánico</option>
        <option value="Otro">Otro (Aclare en Obs y adjunte Doc)</option>
      </select>
      <span class="error-message" id="incumbencias_especificas_error"></span>

      <label for="documentacion_incumbencias">Presenta documentación de incumbencias específicas ( Si / No ):</label>
      <select id="documentacion_incumbencias" name="documentacion_incumbencias" required>
        <option value="SI">SI</option>
        <option value="NO">NO</option>
      </select>
      <span class="error-message" id="documentacion_incumbencias_error"></span>

      <label for="rango_kv">Hasta que rango de KV (13,2 KV técnicos / mas de 13,2 KV inges.):</label>
      <select id="rango_kv" name="rango_kv" required>
        <option value="13.2">13,2 KV técnicos</option>
        <option value="mas_13.2">mas de 13,2 KV inges.</option>
      </select>
      <span class="error-message" id="rango_kv_error"></span>

      <label for="pago_matricula">Presenta documentaci&oacute;n de pago de matr&iacute;cula al d&iacute;a ( si / no
        ):</label>
      <select id="pago_matricula" name="pago_matricula" required>
        <option value="SI">SI</option>
        <option value="NO">NO</option>
      </select>
      <span class="error-message" id="pago_matricula_error"></span>

      <label for="seguro_accidentes">¿Posee seguro de accidentes personales? ( SI / NO ):</label>
 <select id="seguro_accidentes" name="seguro_accidentes" required>
 <option value="SI">SI</option>
 <option value="NO">NO</option>
 </select>
 <span class="error-message" id="seguro_accidentes_error"></span>

 <label for="pago_seguro">¿Presenta la documentación de pago al día del seguro de accidentes personales? ( Si / No ):</label>
 <select id="pago_seguro" name="pago_seguro" required>
 <option value="SI">SI</option>
 <option value="NO">NO</option>
 </select>
 <span class="error-message" id="pago_seguro_error"></span>

      <!-- <hr> -->
<label for="" style="font-size: 9px;">(ste protocolo no tendrá validez legal si no se acredita matrícula habilitante y la incumbencia profesional específica para la tarea declarada.)</label>
      <div class="section-title">DATOS DEL INSTRUMENTO CON EL QUE VAN REALIZAR LAS MEDICIONES</div>

      <label for="marca_instrumento">Marca:</label>
      <input type="text" id="marca_instrumento" name="marca_instrumento" placeholder="Ingrese la marca del instrumento" required>
      <span class="error-message" id="marca_instrumento_error"></span>

      <label for="modelo_instrumento">Modelo:</label>
      <input type="text" id="modelo_instrumento" name="modelo_instrumento" placeholder="Ingrese el modelo del instrumento" required>
      <span class="error-message" id="modelo_instrumento_error"></span>

      <label for="numero_serie_instrumento">Numero de serie:</label>
      <input type="text" id="numero_serie_instrumento" name="numero_serie_instrumento" placeholder="Ingrese el número de serie" required>
      <span class="error-message" id="numero_serie_instrumento_error"></span>

      <div style="display: flex; gap: 20px;">
        <div style="flex: 1;">
          <label for="tipo_instrumento">Tipo ( MFT / Telurímetro / Probador de IDs / MFT de PAT / Otro
            ):</label>
          <select id="tipo_instrumento" name="tipo_instrumento" required>
            <option value="MFT">MFT</option>
            <option value="Telurímetro">Telurímetro</option>
            <option value="Probador de IDs">Probador de IDs</option>
            <option value="MFT de PAT">MFT de PAT</option>
            <option value="Otro">Otro</option>
          </select>
          <span class="error-message" id="tipo_instrumento_error"></span>
        </div>
        <div style="flex: 1;">
          <label for="cumple_iec">Cumple con IEC 61557 ( Si / No ):</label>
          <select id="cumple_iec" name="cumple_iec" required>
            <option value="SI">SI</option>
            <option value="NO">NO</option>
          </select>
          <span class="error-message" id="cumple_iec_error"></span>
        </div>
      </div>
      <div style="display: flex; gap: 20px;">
      </div>
  
  <div style="flex-grow: 1; margin-right: 10px;">
    <label for="certificado_fabricante">Posee certificado de calibraci&oacute;n del fabricante ( Si / No ):</label>
    <select id="certificado_fabricante" name="certificado_fabricante" style="width: 100%;" required>
      <option value="SI">SI</option>
      <option value="NO">NO</option>
    </select>
    <span class="error-message" id="certificado_fabricante_error"></span>
  </div>
  <div style="flex-grow: 1;">
    <label for="condiciones_uso">El instrumento se encuentra en condiciones de uso igual a nuevo ( Si / No ):</label>
    <select id="condiciones_uso" name="condiciones_uso" style="width: 100%;" required>
      <option value="SI">SI</option>
      <option value="NO">NO</option>
    </select>
    <span class="error-message" id="condiciones_uso_error"></span>
  </div>
  <!-- <br>
   
  <hr> -->
  <label for="" style="font-size: 9px;">(Este protocolo no tendrá validez legal si el instrumento no cumple con IEC 61557 y/o no se acredita certificado de calibración vigente.)</label>
  <div class="section-title">Datos de la medicion</div>

  <div style="display: flex; justify-content: space-between;">
    <div style="flex-grow: 1; margin-right: 10px;">
      <label for="fecha_medicion">Fecha de la medici&oacute;n:</label>
      <input type="date" id="fecha_medicion" name="fecha_medicion" required>
      <span class="error-message" id="fecha_medicion_error"></span>
    </div>
    <div style="flex-grow: 1; margin-right: 10px;">
      <label for="hora_inicio">Hora de inicio:</label>
      <input type="time" id="hora_inicio" name="hora_inicio" required>
      <span class="error-message" id="hora_inicio_error"></span>
    </div>
    <div style="flex-grow: 1;">
      <label for="hora_finalizacion">Hora finalización:</label>
      <input type="time" id="hora_finalizacion" name="hora_finalizacion" required>
      <span class="error-message" id="hora_finalizacion_error"></span>
    </div>
  </div>



  <label for="metodologia">Metodología utilizada:</label>
  <textarea id="metodologia" name="metodologia" placeholder="Describa la metodología utilizada" required></textarea>
  <span class="error-message" id="metodologia_error"></span>


  <label for="observaciones">Observaciones:</label>
  <textarea id="observaciones" name="observaciones" placeholder="Ingrese las observaciones"></textarea>

  <!-- <hr> -->
  <div class="section-title">Documentación que se Adjunta a la Medición</div>

  <label for="certificado_calibracion">Certificado de Calibración:</label>
  <select id="certificado_calibracion" name="certificado_calibracion" required>
    <option value="SI">SI</option>
    <option value="NO">NO</option>
  </select>
  <span class="error-message" id="certificado_calibracion_error"></span>

  <label for="plano_croquis">Plano o croquis:</label>
  <select id="plano_croquis" name="plano_croquis" required>
    <option value="SI">SI</option>
    <option value="NO">NO</option>
  </select>
  <span class="error-message" id="plano_croquis_error"></span>

  <button type="button" onclick="generarImagenMapa()">Mostrar ubicación</button>
      <button type="button" id="abrirModalMapaBtn">Seleccionar ubicación manualmente</button>
      <img id="imagenMapa" width="400" height="200" alt="Mapa estático de ubicación" />
      <br>
      <a id="linkMapa" target="_blank" style="display: none;">Ver en Google Maps</a>

  <div class="seccion-adjuntar-archivo">
  <label>Adjuntar Imagen:</label>
  <div>
    <label for="imagen_adjunta" class="custom-file-upload-button">Elegir archivos</label>
    <span id="file-upload-status"></span>
  </div>
 </div>

  <input type="file" id="imagen_adjunta" name="imagen_adjunta" accept="image/*" multiple>
 <div id="imagenes_mostradas"></div>
  <div id="contenedor_imagenes_adjuntas"></div>

  <img src="../img/FIRMADIGITAL.png" alt="Firma Digital" style="float: right; margin-right: 160px; width: 160px; height: auto;">
  
    </form>  
  </div>
  <!-- <button onclick="guardarComoPDF()" style="display: block;">Exportar a PDF</button> -->
  <button id="exportarPDFBtn" class="btn btn-success ms-3 mb-3" onclick="guardarComoPDF()" disabled>Exportar a PDF</button>
  <button id="guardarRegistroBtn" class="btn btn-info ms-3 mb-3" onclick="guardarProtocolo()">Guardar en Base de Datos</button>
    <!-- Botón para abrir modal -->
<button class="btn btn-secondary" id="abrirModalBtn">Buscar y Cargar registro</button>
<button type="button" class="btn btn-danger ms-3 mb-3" onclick="limpiarFormulario()">Limpiar</button>


<!-- Modal -->

<div class="modal fade" id="modalCargaRegistro" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      
      <div class="modal-header">
        <!-- <h5 class="modal-title">Búsqueda de registros</h5> -->
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      
      <div class="modal-body">
        <div class="row">
          <div class="col">
            <label for="fechaDesde" class="form-label">Desde:</label>
            <input type="date" id="fechaDesde" class="form-control">
          </div>
          <div class="col">
            <label for="fechaHasta" class="form-label">Hasta:</label>
            <input type="date" id="fechaHasta" class="form-control">
          </div>
        </div>

        <select id="selectRegistros" class="form-control mt-3 mb-3"></select>
        <div id="imagenesAsociadas" class="d-flex flex-wrap gap-2"></div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    
    </div>
  </div>
</div>

<!-- Modal para el mapa -->
<div class="modal fade" id="modalMapa" tabindex="-1" aria-labelledby="modalMapaLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalMapaLabel">Seleccionar Ubicación</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div id="mapaInteractivo" style="height: 400px;"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-primary" id="confirmarUbicacionBtn">Confirmar Ubicación</button>
      </div>
    </div>
  </div>
</div>


  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://unpkg.com/browser-image-compression@latest/dist/browser-image-compression.js"></script>
  <script src="../js/firebase-config.js"></script>
  <script src="../js/scripts3.js?v1.1"></script>
  <script src="../bootstrap-5.3.6-dist/bootstrap-5.3.6-dist/js/bootstrap.bundle.min.js"></script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAESNgmZ2O6nu3S0z3h8LU8oC67-nPbxhw&callback=initMap"></script>
  
  
  <script>
    // Acá asumimos que ya cargaste la librería browser-image-compression:
    async function guardarProtocolo() {
      if (!validarFormulario()) {
        return;
      }

  const exportarBtn = document.getElementById('exportarPDFBtn');
  const loadingIndicator = document.getElementById('loading-indicator');
  exportarBtn.disabled = true;
  loadingIndicator.style.display = 'block';

  const MAX_SIZE_MB = 10;

  const fileInput = document.getElementById('imagen_adjunta');
  let file = fileInput.files[0];
  let imageUrl = null;

  // Función para aplicar timeout a fetch
  const fetchConTimeout = (url, options, timeout = 10000) => {
    return Promise.race([
      fetch(url, options),
      new Promise((_, reject) =>
        setTimeout(() => reject(new Error('Timeout al intentar conectar con el servidor')), timeout)
      )
    ]);
  };

  if (file) {
    // Validar tipo MIME: solo imágenes permitidas
    const tiposPermitidos = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'image/bmp'];
    if (!tiposPermitidos.includes(file.type)) {
      alert(`Archivo inválido. Solo se permiten imágenes (JPEG, PNG, GIF, WEBP, BMP). No subas videos ni otros formatos.`);
      exportarBtn.disabled = false;
      loadingIndicator.style.display = 'none';
      return;
    }

    // Validar tamaño máximo
    if (file.size > MAX_SIZE_MB * 1024 * 1024) {
      alert(`La imagen es demasiado grande (${(file.size / 1024 / 1024).toFixed(2)}MB). El máximo permitido es ${MAX_SIZE_MB}MB.`);
      exportarBtn.disabled = false;
      loadingIndicator.style.display = 'none';
      return;
    }

    try {
      // Opciones para comprimir la imagen
      const options = {
        maxSizeMB: 2,
        maxWidthOrHeight: 1920,
        useWebWorker: true,
        maxIteration: 10
      };

      // Comprimir imagen
      const compressedFile = await imageCompression(file, options);
      console.log(`Original size: ${(file.size / 1024 / 1024).toFixed(2)} MB`);
      console.log(`Compressed size: ${(compressedFile.size / 1024 / 1024).toFixed(2)} MB`);

      // Preparar FormData
      const formData = new FormData();
      formData.append('image', compressedFile, compressedFile.name || file.name);

      // Subir imagen con timeout 'https://dea.mabcontrol.ar/upload' solo en desarrollo
      const response = await fetchConTimeout('/upload', {
        method: 'POST',
        body: formData
      }, 10000);

      if (!response.ok) {
        throw new Error('Error en la subida del archivo. Estado: ' + response.status);
      }

      const result = await response.json();
      imageUrl = result.imageUrl;

    } catch (error) {
      console.error("Error al comprimir o subir la imagen: ", error);
      alert("Error al procesar o subir la imagen. Intentá de nuevo.");
      exportarBtn.disabled = false;
      loadingIndicator.style.display = 'none';
      return;
    }
  }

  // Armar objeto protocolo
  const fechaMedicionValue = document.getElementById('fecha_medicion').value;
  const horaInicioValue = document.getElementById('hora_inicio').value;
  const fechaHoraInicio = new Date(`${fechaMedicionValue}T${horaInicioValue}`);
  const firestoreTimestamp = firebase.firestore.Timestamp.fromDate(fechaHoraInicio);

  const resp = await fetch(`/mapa-static?lat=${ubicacionLat}&lon=${ubicacionLon}`);
const data = await resp.json();
mapaVpsUrl = data.imageUrl;

    

  const protocolo = {
    razonSocial: document.getElementById('razon_social').value,
    cuit: document.getElementById('cuit').value.replace(/-/g, ""),
    direccion: document.getElementById('direccion').value,
    localidad: document.getElementById('localidad').value,
    cp: document.getElementById('cp').value,
    provincia: document.getElementById('provincia').value,
    nombreProfesional: document.getElementById('nombre_profesional').value,
    apellidoProfesional: document.getElementById('apellido_profesional').value,
    matriculaProfesional: document.getElementById('matricula_profesional').value,
    incumbencias: document.getElementById('incumbencias_especificas').value,
    documentacionIncumbencias: document.getElementById('documentacion_incumbencias').value,
    rangoKv: document.getElementById('rango_kv').value,
    pagoMatricula: document.getElementById('pago_matricula').value,
    seguroAccidentes: document.getElementById('seguro_accidentes').value,
    pagoSeguro: document.getElementById('pago_seguro').value,
    marcaInstrumento: document.getElementById('marca_instrumento').value,
    modeloInstrumento: document.getElementById('modelo_instrumento').value,
    numeroSerieInstrumento: document.getElementById('numero_serie_instrumento').value,
    tipoInstrumento: document.getElementById('tipo_instrumento').value,
    cumpleIec: document.getElementById('cumple_iec').value,
    certificadoFabricante: document.getElementById('certificado_fabricante').value,
    condicionesUso: document.getElementById('condiciones_uso').value,
    fechaMedicion: firestoreTimestamp,
    horaFinalizacion: document.getElementById('hora_finalizacion').value,
    metodologia: document.getElementById('metodologia').value,
    observaciones: document.getElementById('observaciones').value,
    certificadoCalibracion: document.getElementById('certificado_calibracion').value,
    planoCroquis: document.getElementById('plano_croquis').value,
    vpsImageUrl: imageUrl || null,
    mapaUrlVps: mapaVpsUrl || null,
    latitud: ubicacionLat || null,
    longitud: ubicacionLon || null,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  };
  // Timeout para guardar en Firebase
  const agregarConTimeout = (coleccion, data, timeout = 10000) => {
    return Promise.race([
      db.collection(coleccion).add(data),
      new Promise((_, reject) =>
        setTimeout(() => reject(new Error('Timeout al guardar en Firebase')), timeout)
      )
    ]);
  };

  try {
    const docRef = await agregarConTimeout("protocolos", protocolo, 10000);
    console.log("Document written with ID: ", docRef.id);
    alert("¡Protocolo guardado en Firebase!");
  } catch (error) {
    console.error("Error al guardar en Firebase: ", error);
    alert("Error al guardar en Firebase (posible problema de conexión). Intentá nuevamente.");
  } finally {
    exportarBtn.disabled = false;
    loadingIndicator.style.display = 'none';
  }
}

  function mostrarMapa() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;

          const mapa = document.getElementById("mapa");
          const contenedor = document.getElementById("contenedorMapa");

          // Usás la API Embed de Google Maps (requiere API Key si usás "embed/v1/view")
          mapa.src = `https://maps.google.com/maps?q=${lat},${lon}&z=16&output=embed`;

          contenedor.style.display = "block";

        }, function (error) {
          alert("No se pudo obtener la ubicación. Asegurate de permitir el acceso.");
        });
      } else {
        alert("Tu navegador no soporta geolocalización.");
      }
    }

    // Variables globales para almacenar la ubicación
    let ubicacionLat = null;
    let ubicacionLon = null;
    let urlInteractiva = null;
    let urlMapsStatic = null;
    let mapaModal = null;
    let marcador = null;


function generarImagenMapa() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          const lat = position.coords.latitude.toFixed(6); const lon = position.coords.longitude.toFixed(6);
          ubicacionLat = lat; ubicacionLon = lon;
          const zoom = 16;
          const apiKey = 'AIzaSyAESNgmZ2O6nu3S0z3h8LU8oC67-nPbxhw'; 

          urlMapsStatic = `https://maps.googleapis.com/maps/api/staticmap?center=${lat},${lon}&zoom=${zoom}&size=400x200&markers=color:red%7C${lat},${lon}&key=${apiKey}`;
          urlInteractiva = `https://www.google.com/maps/search/?api=1&query=${lat},${lon}`;
          const imagen = document.getElementById("imagenMapa");
          imagen.src = urlMapsStatic;
          imagen.style.display = "block";

          imagen.onload = function () {
              const link = document.getElementById("linkMapa");
              link.href = urlInteractiva;
              link.style.display = "inline-block";
            };
            imagen.onerror = function () {
              // Por si falla la carga del mapa
              link.style.display = "none";
            };

        }, function(error) {
          alert("No se pudo obtener tu ubicación.");
        });
      } else {
        alert("Tu navegador no soporta geolocalización.");
      }
    }
  
async function subirImagenMapa(urlImagen) {
  try {
    const resp = await fetch(urlImagen, {
      method: 'GET',
      headers: {
        'Content-Type': 'image/png'
      }
    });
    const blob = await resp.blob();

    const formData = new FormData();
    formData.append('image', blob, `mapa_${Date.now()}.png`);

    const response = await fetch('/upload', {
      method: 'POST',
      body: formData
    });

    if (!response.ok) {
      throw new Error('Error subiendo el mapa al VPS');
    }

    const result = await response.json();
    return result.imageUrl; // URL pública en tu VPS
  } catch (err) {
    console.error('Error al subir mapa:', err);
    return null;
  }
}

function limpiarFormulario() {
  document.getElementById("protocoloForm").reset();

  const fechaInput = document.getElementById("fecha_medicion");
  if (fechaInput) {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, "0");
    const day = String(today.getDate()).padStart(2, "0");
    fechaInput.value = `${year}-${month}-${day}`;
  }

  document.getElementById("imagenMapa").style.display = "none";
  document.getElementById("linkMapa").style.display = "none";
  document.getElementById("contenedor_imagenes_adjuntas").innerHTML = "";

  document.getElementById("exportarPDFBtn").disabled = true;
  document.getElementById("guardarRegistroBtn").disabled = false;
}

function validarFormulario() {
  let isValid = true;
  const campos = [
    { id: 'razon_social', errorId: 'razon_social_error', message: 'La razón social es obligatoria' },
    { id: 'cuit', errorId: 'cuit_error', message: 'El CUIT debe tener el formato XX-XXXXXXXX-X', pattern: /^\d{2}-\d{8}-\d{1}$/ },
    { id: 'direccion', errorId: 'direccion_error', message: 'La dirección es obligatoria' },
    { id: 'localidad', errorId: 'localidad_error', message: 'La localidad es obligatoria' },
    { id: 'cp', errorId: 'cp_error', message: 'El código postal es obligatorio' },
    { id: 'provincia', errorId: 'provincia_error', message: 'La provincia es obligatoria' },
    { id: 'nombre_profesional', errorId: 'nombre_profesional_error', message: 'El nombre del profesional es obligatorio' },
    { id: 'apellido_profesional', errorId: 'apellido_profesional_error', message: 'El apellido del profesional es obligatorio' },
    { id: 'matricula_profesional', errorId: 'matricula_profesional_error', message: 'La matrícula es obligatoria' },
    { id: 'incumbencias_especificas', errorId: 'incumbencias_especificas_error', message: 'Las incumbencias son obligatorias' },
    { id: 'documentacion_incumbencias', errorId: 'documentacion_incumbencias_error', message: 'La documentación de incumbencias es obligatoria' },
    { id: 'rango_kv', errorId: 'rango_kv_error', message: 'El rango de KV es obligatorio' },
    { id: 'pago_matricula', errorId: 'pago_matricula_error', message: 'El pago de matrícula es obligatorio' },
    { id: 'seguro_accidentes', errorId: 'seguro_accidentes_error', message: 'El seguro de accidentes es obligatorio' },
    { id: 'pago_seguro', errorId: 'pago_seguro_error', message: 'El pago del seguro es obligatorio' },
    { id: 'marca_instrumento', errorId: 'marca_instrumento_error', message: 'La marca del instrumento es obligatoria' },
    { id: 'modelo_instrumento', errorId: 'modelo_instrumento_error', message: 'El modelo del instrumento es obligatorio' },
    { id: 'numero_serie_instrumento', errorId: 'numero_serie_instrumento_error', message: 'El número de serie es obligatorio' },
    { id: 'tipo_instrumento', errorId: 'tipo_instrumento_error', message: 'El tipo de instrumento es obligatorio' },
    { id: 'cumple_iec', errorId: 'cumple_iec_error', message: 'Debe indicar si cumple con IEC 61557' },
    { id: 'certificado_fabricante', errorId: 'certificado_fabricante_error', message: 'Debe indicar si posee certificado del fabricante' },
    { id: 'condiciones_uso', errorId: 'condiciones_uso_error', message: 'Debe indicar las condiciones de uso' },
    { id: 'fecha_medicion', errorId: 'fecha_medicion_error', message: 'La fecha de medición es obligatoria' },
    { id: 'hora_inicio', errorId: 'hora_inicio_error', message: 'La hora de inicio es obligatoria' },
    { id: 'hora_finalizacion', errorId: 'hora_finalizacion_error', message: 'La hora de finalización es obligatoria' },
    { id: 'metodologia', errorId: 'metodologia_error', message: 'La metodología es obligatoria' },
    { id: 'certificado_calibracion', errorId: 'certificado_calibracion_error', message: 'Debe indicar si se adjunta certificado de calibración' },
    { id: 'plano_croquis', errorId: 'plano_croquis_error', message: 'Debe indicar si se adjunta plano o croquis' },
  ];

  campos.forEach(campo => {
    const input = document.getElementById(campo.id);
    const error = document.getElementById(campo.errorId);
    let valid = true;

    let value = input.value;
    if (campo.id === 'cuit') {
      value = value.replace(/-/g, "");
    }

    if (!value) {
      valid = false;
    } else if (campo.pattern && !campo.pattern.test(input.value)) {
      valid = false;
    }

    if (!valid) {
      error.textContent = campo.message;
      isValid = false;
    } else {
      error.textContent = '';
    }
  });

  return isValid;
}

function initMap() {
  const modalMapaEl = document.getElementById('modalMapa');
  modalMapaEl.classList.remove("show");
  modalMapaEl.style.display = "none";
  mapaModal = new bootstrap.Modal(modalMapaEl, { show: false });

  const mapaInteractivoEl = document.getElementById('mapaInteractivo');
  const map = new google.maps.Map(mapaInteractivoEl, {
    center: { lat: -34.603722, lng: -58.381592 }, // Centro de Buenos Aires
    zoom: 8,
  });

  google.maps.event.addListener(map, 'click', function(event) {
    if (marcador) {
      marcador.setMap(null);
    }
    marcador = new google.maps.Marker({
      position: event.latLng,
      map: map
    });
  });

  document.getElementById('abrirModalMapaBtn').addEventListener('click', function() {
    mapaModal.show();
  });

  document.getElementById('confirmarUbicacionBtn').addEventListener('click', function() {
    if (marcador) {
      const lat = marcador.getPosition().lat().toFixed(6);
      const lon = marcador.getPosition().lng().toFixed(6);
      ubicacionLat = lat;
      ubicacionLon = lon;

      const zoom = 16;
      const apiKey = 'AIzaSyAESNgmZ2O6nu3S0z3h8LU8oC67-nPbxhw';
      urlMapsStatic = `https://maps.googleapis.com/maps/api/staticmap?center=${lat},${lon}&zoom=${zoom}&size=400x200&markers=color:red%7C${lat},${lon}&key=${apiKey}`;
      urlInteractiva = `https://www.google.com/maps/search/?api=1&query=${lat},${lon}`;

      const imagen = document.getElementById("imagenMapa");
      imagen.src = urlMapsStatic;
      imagen.style.display = "block";

      imagen.onload = function () {
          const link = document.getElementById("linkMapa");
          link.href = urlInteractiva;
          link.style.display = "inline-block";
        };
        imagen.onerror = function () {
          link.style.display = "none";
        };
      
      mapaModal.hide();
    } else {
      alert('Por favor, selecciona una ubicación en el mapa.');
    }
  });
}

  </script>

<script>

const abrirModalBtn = document.getElementById("abrirModalBtn"); // Botón para abrir el modal
const modalCargaRegistro = document.getElementById("modalCargaRegistro"); // Modal de carga de registro
const modal = new bootstrap.Modal(modalCargaRegistro, { show: false }); // Inicializar modal de Bootstrap
const fechaDesde = document.getElementById("fechaDesde");
const fechaHasta = document.getElementById("fechaHasta");
//const buscarRegistrosBtn = document.getElementById("buscarRegistrosBtn");
const selectRegistros = document.getElementById("selectRegistros");
const imagenesAsociadas = document.getElementById("imagenesAsociadas");

// 🔹 Forzar modal oculto al iniciar
modalCargaRegistro.classList.remove("show");
modalCargaRegistro.style.display = "none";
document.body.classList.remove("modal-open");
document.querySelectorAll(".modal-backdrop").forEach(el => el.remove());

let primeraAperturaModal = true; // Control de primera apertura
// Abrir modal, setear fechas de hoy
abrirModalBtn.addEventListener("click", async () => {
  
if (primeraAperturaModal) {
    const hoy = new Date().toISOString().split('T')[0];
    fechaDesde.value = hoy;
    fechaHasta.value = hoy;
    primeraAperturaModal = false; // Desactivar para futuras aperturas
  }
  modal.show();
buscarRegistros(); // 🔹 búsqueda automática solo 1 vez
});

// 🔹 Disparar búsqueda automática al cambiar fechas
fechaDesde.addEventListener("change", () => {
  if (fechaDesde.value && fechaHasta.value) {
    buscarRegistros();
  }
});

fechaHasta.addEventListener("change", () => {
  if (fechaDesde.value && fechaHasta.value) {
    buscarRegistros();
  }
});

// Buscar registros
async function buscarRegistros() {
  const desde = fechaDesde.value;
  const hasta = fechaHasta.value;

  if (!desde || !hasta) {
    alert("Seleccioná ambas fechas.");
    return;
  }

  loadingIndicator.innerText = "Buscando registros...";
  loadingIndicator.style.display = 'block';

  const desdeDate = new Date(desde + "T00:00:00");
  const hastaDate = new Date(hasta + "T23:59:59");

  const desdeTimestamp = firebase.firestore.Timestamp.fromDate(desdeDate);
  const hastaTimestamp = firebase.firestore.Timestamp.fromDate(hastaDate);

  try {
    const snapshot = await db.collection("protocolos")
      .where("fechaMedicion", ">=", desdeTimestamp)
      .where("fechaMedicion", "<=", hastaTimestamp)
      .orderBy("fechaMedicion", "desc")
      .get();

    selectRegistros.innerHTML = "";

    if (snapshot.empty) {
      selectRegistros.innerHTML = "<option>No se encontraron registros</option>";
      selectRegistros.size = 1;
      return;
    }

    snapshot.forEach(doc => {
      const data = doc.data();
      const fecha = data.fechaMedicion.toDate().toLocaleDateString("es-AR");
      const horaInicio = data.fechaMedicion.toDate().toLocaleTimeString("es-AR", { hour: '2-digit', minute: '2-digit' });
      const option = document.createElement("option");
      option.value = doc.id;
      option.textContent = `${data.razonSocial} - ${fecha} ${horaInicio} - ${data.horaFinalizacion}`;
      option.dataset.raw = JSON.stringify(data);
      selectRegistros.appendChild(option);
    });
    // Después de llenar el select
      selectRegistros.selectedIndex = -1; // Ninguna opción seleccionada
    // Si hay más de 10 registros, se muestra scroll
    // Mostrar siempre al menos 2 filas para que sea clickeable
      selectRegistros.size = snapshot.size > 10 ? 10 : Math.max(snapshot.size, 2);


  } catch (error) {
    console.error("Error al buscar registros: ", error);
    alert("Error al consultar Firebase. Probá más tarde.");
  } finally {
    loadingIndicator.style.display = 'none';
  }
};

// Cargar datos del registro seleccionado en el formulario
selectRegistros.addEventListener("change", async () => {
  

  const selectedOption = selectRegistros.options[selectRegistros.selectedIndex];
  if (!selectedOption || !selectedOption.dataset.raw) return;

  const data = JSON.parse(selectedOption.dataset.raw);
  data.fechaMedicion = new firebase.firestore.Timestamp(data.fechaMedicion.seconds, data.fechaMedicion.nanoseconds);

  const cargarCampo = (id, valor) => {
    const el = document.getElementById(id);
    if (el) el.value = valor || "";
  };

  cargarCampo("razon_social", data.razonSocial);
  cargarCampo("cuit", data.cuit);
  cargarCampo("direccion", data.direccion);
  cargarCampo("localidad", data.localidad);
  cargarCampo("cp", data.cp);
  cargarCampo("provincia", data.provincia);
  cargarCampo("nombre_profesional", data.nombreProfesional);
  cargarCampo("apellido_profesional", data.apellidoProfesional);
  cargarCampo("matricula_profesional", data.matriculaProfesional);
  cargarCampo("incumbencias_especificas", data.incumbencias);
  cargarCampo("documentacion_incumbencias", data.documentacionIncumbencias);
  cargarCampo("rango_kv", data.rangoKv);
  cargarCampo("pago_matricula", data.pagoMatricula);
  cargarCampo("seguro_accidentes", data.seguroAccidentes);
  cargarCampo("pago_seguro", data.pagoSeguro);
  cargarCampo("marca_instrumento", data.marcaInstrumento);
  cargarCampo("modelo_instrumento", data.modeloInstrumento);
  cargarCampo("numero_serie_instrumento", data.numeroSerieInstrumento);
  cargarCampo("tipo_instrumento", data.tipoInstrumento);
  cargarCampo("cumple_iec", data.cumpleIec);
  cargarCampo("certificado_fabricante", data.certificadoFabricante);
  cargarCampo("condiciones_uso", data.condicionesUso);
  cargarCampo("hora_inicio", data.fechaMedicion.toDate().toTimeString().slice(0, 5));
  cargarCampo("fecha_medicion", data.fechaMedicion.toDate().toISOString().split('T')[0]);
  cargarCampo("hora_finalizacion", data.horaFinalizacion);
  cargarCampo("metodologia", data.metodologia);
  cargarCampo("observaciones", data.observaciones);
  cargarCampo("certificado_calibracion", data.certificadoCalibracion);
  cargarCampo("plano_croquis", data.planoCroquis);

  const contenedorImagenes = document.getElementById("contenedor_imagenes_adjuntas");
  contenedorImagenes.innerHTML = "";
  if (data.vpsImageUrl) {
    const img = document.createElement("img");
    img.src = data.vpsImageUrl;
    img.style.maxWidth = "200px";
    img.style.maxHeight = "200px";
    img.style.border = "1px solid #ccc";
    img.style.borderRadius = "5px";
    img.title = "Imagen del registro cargado";
    contenedorImagenes.appendChild(img);
  }

  const imagenMapa = document.getElementById("imagenMapa");
  const linkMapa = document.getElementById("linkMapa");

  if (data.mapaUrlVps) {
    imagenMapa.src = data.mapaUrlVps;
    imagenMapa.style.display = "block";

    if (data.latitud && data.longitud) {
      const urlInteractiva = `https://www.google.com/maps/search/?api=1&query=${data.latitud},${data.longitud}`;
      linkMapa.href = urlInteractiva;
      linkMapa.style.display = "inline-block";
    } else {
      linkMapa.style.display = "none";
    }
  } else {
    imagenMapa.style.display = "none";
    linkMapa.style.display = "none";
  }

  exportarPDFBtn.disabled = false;
  guardarRegistroBtn.disabled = true;

  const formElements = document.querySelectorAll('#exportPDF form input, #exportPDF form select, #exportPDF form textarea');
  formElements.forEach(el => {
    el.addEventListener('input', () => {
      guardarRegistroBtn.disabled = false;
    }, { once: true });
  });

  modal.hide();
});


  function guardarComoPDF() {
    const botones = [exportarPDFBtn, guardarRegistroBtn, abrirModalBtn];
    botones.forEach(btn => btn.style.display = "none");

    // Muestra el indicador de carga
    document.getElementById('loading-indicator').style.display = 'block';
    window.scrollTo(0, 0);
    const contenedor = document.getElementById("exportPDF");
    const tabla = document.getElementById("medicionTabla"); // Assuming you have a table with this ID if needed for page breaks
    contenedor.classList.add("pdf-export", "ocultar-botones");
    if (tabla) {
      tabla.classList.add("ocultar-eliminar");
    }

    // Agrega fecha/hora arriba a la derecha SOLO para el PDF
    const ahora = new Date();
    const fechaHora = ahora.toLocaleString("es-AR", {
      day: "2-digit",
      month: "2-digit",
      year: "numeric",
      hour: "2-digit",
      minute: "2-digit",
    });
    const fechaDiv = document.createElement("div");
    fechaDiv.className = "fecha-hora-impresion";
    fechaDiv.style.position = "absolute";
    fechaDiv.style.top = "20px";
    fechaDiv.style.right = "40px";
    fechaDiv.style.fontSize = "11px";
    fechaDiv.style.fontWeight = "bold";
    fechaDiv.style.color = "#333";
    fechaDiv.textContent = fechaHora;
    contenedor.prepend(fechaDiv);

    // CSS para evitar cortes de filas y encabezados (partially handled by html2pdf options)
    // Additional styling for print can be added in style.css with @media print

    // Fuerza reflow (often not strictly necessary with modern browsers and libraries)
    // void tabla.offsetHeight;

    setTimeout(() => {
      const opciones = {
        margin: [5, 5, 15, 5],
        filename: "planillaMedicPAT1.pdf",
        image: { type: "jpeg", quality: 0.98 },
        html2canvas: { scale: 2, scrollY: 0, scrollX: 0, useCORS: true },
        jsPDF: { unit: "mm", format: "a4", orientation: "portrait" },
        pagebreak: { mode: ["avoid-all", "css", "legacy"] },
      };

      html2pdf()
        .set(opciones)
        .from(contenedor)
        .toPdf()
        .get("pdf")
        .then(function (pdf) {
          const totalPages = pdf.internal.getNumberOfPages();
          const pageWidth = pdf.internal.pageSize.getWidth();
          const pageHeight = pdf.internal.pageSize.getHeight();
          for (let i = 1; i <= totalPages; i++) {
            pdf.setPage(i);
            pdf.setFontSize(10);
            pdf.text(
              `Página ${i} de ${totalPages}`,
              pageWidth - 30,
              pageHeight - 10
            );
          }
        })
        .save()
        .then(() => {
          contenedor.classList.remove("pdf-export", "ocultar-botones");
          if (tabla) {
            tabla.classList.remove("ocultar-eliminar");
          }
          fechaDiv.remove(); // Quita la fecha/hora del DOM
          document.getElementById('loading-indicator').style.display = 'none';
          botones.forEach(btn => btn.style.display = "");
        });
    }, 350); // Use a small delay to ensure DOM updates
  }
</script>

<div id="loadingIndicator" class="text-center my-2" style="display: none;">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Cargando...</span>
  </div>
  <p class="mt-2">Buscando registros...</p>
</div>
  <div id="loading-indicator" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(255, 255, 255, 0.8); padding: 20px; border-radius: 10px; z-index: 1000;">
    Subiendo imagen y guardando datos, por favor espera....
  </div>
</body>


</html>