<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <link rel="shortcut icon" href="../img/logoDEA3.jfif" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <link rel="stylesheet" href="../css/styles.css?v1.1">

  <title>PROTOCOLO DE MEDICIÓN</title>
  
</head>

<body>
  <div id="exportPDF">
    <form>
      <img src="../img/logoDEA3.jfif" alt="Logo" style="position: absolute; top: 10px; left: 10px; width: 150px;">
      <h2 class="title">PROTOCOLO DE MEDICIÓN DE LA PUESTA A TIERRA Y CONTINUIDAD DE LAS MASAS</h2>

      <label for="razon_social">Razón Social:</label>
      <input type="text" id="razon_social" name="razon_social" value="razon_social">
      <label for="cuit">C.U.I.T.:</label>
      <input type="text" id="cuit" name="cuit" value="cuit">
      <label for="direccion">Dirección:</label>
      <input type="text" id="direccion" name="direccion" value="direccion">

      <label for="localidad">Localidad:</label>
      <input type="text" id="localidad" name="localidad" value="localidad">

      <div style="display: flex; gap: 20px;">
        <div style="flex: 1;">
          <label for="cp">CP:</label>
          <input type="text" id="cp" name="cp" value="cp">
        </div>
        <div style="flex: 1;">
          <label for="provincia">Provincia:</label>
          <select id="provincia" name="provincia">
            <option value="">Seleccionar Provincia</option>
            <option value="Buenos Aires">Buenos Aires</option>
            <option value="Catamarca">Catamarca</option>
            <option value="Chaco">Chaco</option>
            <option value="Chubut">Chubut</option>
            <option value="Córdoba">Córdoba</option>
            <option value="Corrientes">Corrientes</option>
            <option value="Entre Ríos">Entre Ríos</option>
            <option value="Formosa">Formosa</option>
            <option value="Jujuy">Jujuy</option>
            <option value="La Pampa">La Pampa</option>
            <option value="La Rioja">La Rioja</option>
            <option value="Mendoza">Mendoza</option>
            <option value="Misiones">Misiones</option>
            <option value="Neuquén">Neuquén</option>
            <option value="Río Negro">Río Negro</option>
            <option value="Salta">Salta</option>
            <option value="San Juan">San Juan</option>
            <option value="San Luis">San Luis</option>
            <option value="Santa Cruz">Santa Cruz</option>
            <option value="Santa Fe">Santa Fe</option>
            <option value="Santiago del Estero">Santiago del Estero</option>
            <option value="Tierra del Fuego, Antártida e Islas del Atlántico Sur">Tierra del Fuego, Antártida e Islas
              del Atlántico Sur</option>
            <option value="Tucumán">Tucumán</option>
          </select>
        </div>

      </div>
          <!-- <hr> -->
      <div class="section-title">DATOS DEL PROFESIONAL QUE VA REALIZAR LAS MEDICIONES</div>

      <label for="nombre_profesional">Nombre:</label>
      <input type="text" id="nombre_profesional" name="nombre_profesional" value="nombre_profesional">

      <label for="apellido_profesional">Apellido:</label>
      <input type="text" id="apellido_profesional" name="apellido_profesional" value="apellido_profesional">

      <label for="matricula_profesional">Matrícula N°:</label>
      <input type="text" id="matricula_profesional" name="matricula_profesional" value="matricula_profesional">

      <label for="incumbencias_electricidad">Posee incumbencias específicas en electricidad (si /no ):</label>
      <select id="incumbencias_especificas" name="incumbencias_especificas">
        <option value="Técnico eléctrico">Técnico eléctrico</option>
        <option value="Técnico Electromecánico">Técnico Electromecánico</option>
        <option value="Ingeniero eléctrico">Ingeniero eléctrico</option>
        <option value="Ingeniero electromecánico">Ingeniero electromecánico</option>
      </select>

      <label for="documentacion_incumbencias">Presenta documentación de incumbencias específicas ( Si / No ):</label>
      <select id="documentacion_incumbencias" name="documentacion_incumbencias">
        <option value="SI">SI</option>
        <option value="NO">NO</option>
      </select>
      <label for="rango_kv">Hasta que rango de KV (13,2 KV técnicos / mas de 13,2 KV inges.):</label>
      <select id="rango_kv" name="rango_kv">
        <option value="13.2">13,2 KV técnicos</option>
        <option value="mas_13.2">mas de 13,2 KV inges.</option>
      </select>

      <label for="pago_matricula">Presenta documentaci&oacute;n de pago de matr&iacute;cula al d&iacute;a ( si / no
        ):</label>
      <select id="pago_matricula" name="pago_matricula">
        <option value="SI">SI</option>
        <option value="NO">NO</option>
      </select>

      <label for="seguro_accidentes">¿Posee seguro de accidentes personales? ( SI / NO ):</label>
 <select id="seguro_accidentes" name="seguro_accidentes">
 <option value="SI">SI</option>
 <option value="NO">NO</option>
 </select>

 <label for="pago_seguro">¿Presenta la documentación de pago al día del seguro de accidentes personales? ( Si / No ):</label>
 <select id="pago_seguro" name="pago_seguro">
 <option value="SI">SI</option>
 <option value="NO">NO</option>
 </select>

      <!-- <hr> -->

      <div class="section-title">DATOS DEL INSTRUMENTO CON EL QUE VAN REALIZAR LAS MEDICIONES</div>

      <label for="marca_instrumento">Marca:</label>
      <input type="text" id="marca_instrumento" name="marca_instrumento" value="marca_instrumento">

      <label for="modelo_instrumento">Modelo:</label>
      <input type="text" id="modelo_instrumento" name="modelo_instrumento" value="modelo_instrumento">

      <label for="numero_serie_instrumento">Numero de serie:</label>
      <input type="text" id="numero_serie_instrumento" name="numero_serie_instrumento" value="numero_serie_instrumento">

      <div style="display: flex; gap: 20px;">
        <div style="flex: 1;">
          <label for="tipo_instrumento">Tipo ( MFT / Telurímetro / Probador de IDs / MFT de PAT / Otro
            ):</label>
          <select id="tipo_instrumento" name="tipo_instrumento">
            <option value="MFT">MFT</option>
            <option value="Telurímetro">Telurímetro</option>
            <option value="Probador de IDs">Probador de IDs</option>
            <option value="MFT de PAT">MFT de PAT</option>
            <option value="Otro">Otro</option>
          </select>
        </div>
        <div style="flex: 1;">
          <label for="cumple_iec">Cumple con IEC 61557 ( Si / No ):</label>
          <select id="cumple_iec" name="cumple_iec">
            <option value="SI">SI</option>
            <option value="NO">NO</option>
          </select>
        </div>
      </div>
      <div style="display: flex; gap: 20px;">
      </div>
  
  <div style="flex-grow: 1; margin-right: 10px;">
    <label for="certificado_fabricante">Posee certificado de calibraci&oacute;n del fabricante ( Si / No ):</label>
    <select id="certificado_fabricante" name="certificado_fabricante" style="width: 100%;">
      <option value="SI">SI</option>
      <option value="NO">NO</option>
    </select>
  </div>
  <div style="flex-grow: 1;">
    <label for="condiciones_uso">El instrumento se encuentra en condiciones de uso igual a nuevo ( Si / No ):</label>
    <select id="condiciones_uso" name="condiciones_uso" style="width: 100%;">
      <option value="SI">SI</option>
      <option value="NO">NO</option>
    </select>
  </div>
  <!-- <br>
  <hr> -->
  <div class="section-title">Datos de la medicion</div>

  <div style="display: flex; justify-content: space-between;">
    <div style="flex-grow: 1; margin-right: 10px;">
      <label for="fecha_medicion">Fecha de la medici&oacute;n:</label>
      <input type="date" id="fecha_medicion" name="fecha_medicion">
    </div>
    <div style="flex-grow: 1; margin-right: 10px;">
      <label for="hora_inicio">Hora de inicio:</label>
      <input type="time" id="hora_inicio" name="hora_inicio">
    </div>
    <div style="flex-grow: 1;">
      <label for="hora_finalizacion">Hora finalización:</label>
      <input type="time" id="hora_finalizacion" name="hora_finalizacion">
    </div>
  </div>



  <label for="metodologia">Metodología utilizada:</label>
  <textarea id="metodologia" name="metodologia"></textarea>


  <label for="observaciones">Observaciones:</label>
  <textarea id="observaciones" name="observaciones"></textarea>
  <!-- <hr> -->
  <div class="section-title">Documentación que se Adjunta a la Medición</div>

  <label for="certificado_calibracion">Certificado de Calibración:</label>
  <select id="certificado_calibracion" name="certificado_calibracion">
    <option value="SI">SI</option>
    <option value="NO">NO</option>
  </select>

  <label for="plano_croquis">Plano o croquis:</label>
  <select id="plano_croquis" name="plano_croquis">
    <option value="SI">SI</option>
    <option value="NO">NO</option>
  </select>

  <div class="seccion-adjuntar-archivo">
  <label>Adjuntar Imagen:</label>
  <div>
    <label for="imagen_adjunta" class="custom-file-upload-button">Elegir archivos</label>
    <span id="file-upload-status"></span>
  </div>
 </div>

  <input type="file" id="imagen_adjunta" name="imagen_adjunta" accept="image/*" multiple>
 <div id="imagenes_mostradas"></div>
  <div id="contenedor_imagenes_adjuntas"></div>

  <img src="../img/FIRMADIGITAL.png" alt="Firma Digital" style="float: right; margin-right: 160px; width: 160px; height: auto;">

</form>
  
  </div>
  
  
  <!-- <button onclick="guardarComoPDF()" style="display: block;">Exportar a PDF</button> -->
  <button id="exportarPDFBtn" class="btn btn-success ms-3 mb-3" onclick="guardarComoPDF()" disabled>Exportar a PDF</button>
  <button class="btn btn-info ms-3 mb-3" onclick="guardarProtocolo()">Guardar en Base de Datos</button>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://unpkg.com/browser-image-compression@latest/dist/browser-image-compression.js"></script>
  <script src="../js/firebase-config.js"></script>
  <script src="../js/scripts3.js?v1.1"></script>
  
  
  <script>
    // Acá asumimos que ya cargaste la librería browser-image-compression:
async function guardarProtocolo() {
  const exportarBtn = document.getElementById('exportarPDFBtn');
  const loadingIndicator = document.getElementById('loading-indicator');
  exportarBtn.disabled = true;
  loadingIndicator.style.display = 'block';

  const MAX_SIZE_MB = 10;

  const camposRequeridos = [
    { id: 'razon_social', nombre: 'Razón Social' },
    { id: 'cuit', nombre: 'CUIT' },
    { id: 'direccion', nombre: 'Dirección' },
    { id: 'localidad', nombre: 'Localidad' },
    { id: 'provincia', nombre: 'Provincia' },
    { id: 'nombre_profesional', nombre: 'Nombre del Profesional' },
    { id: 'apellido_profesional', nombre: 'Apellido del Profesional' },
    { id: 'matricula_profesional', nombre: 'Matrícula del Profesional' },
    { id: 'marca_instrumento', nombre: 'Marca del Instrumento' },
    { id: 'modelo_instrumento', nombre: 'Modelo del Instrumento' },
    { id: 'numero_serie_instrumento', nombre: 'Número de Serie del Instrumento' },
    { id: 'fecha_medicion', nombre: 'Fecha de Medición' },
    { id: 'hora_inicio', nombre: 'Hora de Inicio' },
    { id: 'hora_finalizacion', nombre: 'Hora de Finalización' }
  ];

  // Validación de campos
  for (const campo of camposRequeridos) {
    const input = document.getElementById(campo.id);
    if (!input.value.trim()) {
      alert(`Por favor, completa el campo "${campo.nombre}".`);
      input.focus();
      exportarBtn.disabled = false;
      loadingIndicator.style.display = 'none';
      return;
    }
  }

  const fileInput = document.getElementById('imagen_adjunta');
  let file = fileInput.files[0];
  let imageUrl = null;

  // Función para aplicar timeout a fetch
  const fetchConTimeout = (url, options, timeout = 10000) => {
    return Promise.race([
      fetch(url, options),
      new Promise((_, reject) =>
        setTimeout(() => reject(new Error('Timeout al intentar conectar con el servidor')), timeout)
      )
    ]);
  };

  if (file) {
    // Validar tipo MIME: solo imágenes permitidas
    const tiposPermitidos = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'image/bmp'];
    if (!tiposPermitidos.includes(file.type)) {
      alert(`Archivo inválido. Solo se permiten imágenes (JPEG, PNG, GIF, WEBP, BMP). No subas videos ni otros formatos.`);
      exportarBtn.disabled = false;
      loadingIndicator.style.display = 'none';
      return;
    }

    // Validar tamaño máximo
    if (file.size > MAX_SIZE_MB * 1024 * 1024) {
      alert(`La imagen es demasiado grande (${(file.size / 1024 / 1024).toFixed(2)}MB). El máximo permitido es ${MAX_SIZE_MB}MB.`);
      exportarBtn.disabled = false;
      loadingIndicator.style.display = 'none';
      return;
    }

    try {
      // Opciones para comprimir la imagen
      const options = {
        maxSizeMB: 2,
        maxWidthOrHeight: 1920,
        useWebWorker: true,
        maxIteration: 10
      };

      // Comprimir imagen
      const compressedFile = await imageCompression(file, options);
      console.log(`Original size: ${(file.size / 1024 / 1024).toFixed(2)} MB`);
      console.log(`Compressed size: ${(compressedFile.size / 1024 / 1024).toFixed(2)} MB`);

      // Preparar FormData
      const formData = new FormData();
      formData.append('image', compressedFile, compressedFile.name || file.name);

      // Subir imagen con timeout
      const response = await fetchConTimeout('http://dea.mabcontrol.ar:3001/upload', {
        method: 'POST',
        body: formData
      }, 10000);

      if (!response.ok) {
        throw new Error('Error en la subida del archivo. Estado: ' + response.status);
      }

      const result = await response.json();
      imageUrl = result.imageUrl;

    } catch (error) {
      console.error("Error al comprimir o subir la imagen: ", error);
      alert("Error al procesar o subir la imagen. Intentá de nuevo.");
      exportarBtn.disabled = false;
      loadingIndicator.style.display = 'none';
      return;
    }
  }

  // Armar objeto protocolo
  const protocolo = {
    razonSocial: document.getElementById('razon_social').value,
    cuit: document.getElementById('cuit').value,
    direccion: document.getElementById('direccion').value,
    localidad: document.getElementById('localidad').value,
    cp: document.getElementById('cp').value,
    provincia: document.getElementById('provincia').value,
    nombreProfesional: document.getElementById('nombre_profesional').value,
    apellidoProfesional: document.getElementById('apellido_profesional').value,
    matriculaProfesional: document.getElementById('matricula_profesional').value,
    incumbencias: document.getElementById('incumbencias_especificas').value,
    documentacionIncumbencias: document.getElementById('documentacion_incumbencias').value,
    rangoKv: document.getElementById('rango_kv').value,
    pagoMatricula: document.getElementById('pago_matricula').value,
    seguroAccidentes: document.getElementById('seguro_accidentes').value,
    pagoSeguro: document.getElementById('pago_seguro').value,
    marcaInstrumento: document.getElementById('marca_instrumento').value,
    modeloInstrumento: document.getElementById('modelo_instrumento').value,
    numeroSerieInstrumento: document.getElementById('numero_serie_instrumento').value,
    tipoInstrumento: document.getElementById('tipo_instrumento').value,
    cumpleIec: document.getElementById('cumple_iec').value,
    certificadoFabricante: document.getElementById('certificado_fabricante').value,
    condicionesUso: document.getElementById('condiciones_uso').value,
    fechaMedicion: document.getElementById('fecha_medicion').value,
    horaInicio: document.getElementById('hora_inicio').value,
    horaFinalizacion: document.getElementById('hora_finalizacion').value,
    metodologia: document.getElementById('metodologia').value,
    observaciones: document.getElementById('observaciones').value,
    certificadoCalibracion: document.getElementById('certificado_calibracion').value,
    planoCroquis: document.getElementById('plano_croquis').value,
    vpsImageUrl: imageUrl || null,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  };

  // Timeout para guardar en Firebase
  const agregarConTimeout = (coleccion, data, timeout = 10000) => {
    return Promise.race([
      db.collection(coleccion).add(data),
      new Promise((_, reject) =>
        setTimeout(() => reject(new Error('Timeout al guardar en Firebase')), timeout)
      )
    ]);
  };

  try {
    const docRef = await agregarConTimeout("protocolos", protocolo, 10000);
    console.log("Document written with ID: ", docRef.id);
    alert("¡Protocolo guardado en Firebase!");
  } catch (error) {
    console.error("Error al guardar en Firebase: ", error);
    alert("Error al guardar en Firebase (posible problema de conexión). Intentá nuevamente.");
  } finally {
    exportarBtn.disabled = false;
    loadingIndicator.style.display = 'none';
  }
}

  </script>
  <div id="loading-indicator" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(255, 255, 255, 0.8); padding: 20px; border-radius: 10px; z-index: 1000;">
    Subiendo imagen y guardando datos, por favor espera....
  </div>
</body>


</html>
